$.mbMenu={actualMenuOpener:false,options:{template:"yourMenuVoiceTemplate",additionalData:"",menuSelector:".menuContainer",menuWidth:150,openOnRight:false,iconPath:"ico/",hasImages:true,fadeTime:100,menuTop:0,menuLeft:0,submenuTop:0,submenuLeft:4,opacity:1,shadow:false,shadowColor:"black",openOnClick:true,shadowOpacity:0.2,containerStyle:{padding:1,paddingTop:3}},buildMenu:function(A){return this.each(function(){var D=this;D.id=!this.id?"menu_"+Math.floor(Math.random()*1000):this.id;this.options={};$.extend(this.options,$.mbMenu.options);$.extend(this.options,A);$(".menu").hide();D.clicked=false;D.rootMenu=false;D.clearClicked=false;D.actualOpenedMenu=false;D.menuvoice=false;var B=$(this);var C=this.options.openOnClick;$(B).each(function(F){D.menuvoice=$(this).find("[menu]");$(D.menuvoice).each(function(){$(this).addClass("rootVoice");$(this).attr("nowrap","nowrap")});var G=C?"click":"mouseover";$(D.menuvoice).bind(G,function(){if(!$(this).attr("isOpen")){$(this).buildMbMenu(D,$(this).attr("menu"))}$(this).attr("isOpen","true");return false});if(!C){$(D.menuvoice).bind("mouseout",function(){})}var H=$.browser.msie?"mouseenter":"mouseover";var E=$.browser.msie?"mouseleave":"mouseout";$(D.menuvoice).bind(H,function(){if(!C){$(D).find(".selected").removeClass("selected")}if(D.actualOpenedMenu){$(D.actualOpenedMenu).removeClass("selected")}$(this).addClass("selected");if(D.clicked&&!$(this).attr("isOpen")){clearTimeout(D.clearClicked);$(this).buildMbMenu(D,$(this).attr("menu"))}});$(D.menuvoice).bind(E,function(){if(!D.clicked){$(this).removeClass("selected")}$(document).bind("click",function(){$(this).removeMbMenu(D)})})})})},buildContextualMenu:function(A){return this.each(function(){var C=this;C.id=!this.id?"menu_"+Math.floor(Math.random()*100):this.id;this.options={};$.extend(this.options,$.mbMenu.options);$.extend(this.options,A);C.clicked=false;C.rootMenu=false;C.clearClicked=false;C.actualOpenedMenu=false;C.menuvoice=false;var B=$("[cMenu]");$(B).each(function(D){$(this).css({cursor:"default"});$(this).bind("contextmenu",function(E){E.preventDefault();if($.mbMenu.options.actualMenuOpener){$(C).removeMbMenu($.mbMenu.options.actualMenuOpener)}$(this).buildMbMenu(C,$(this).attr("cMenu"),"cm",E);$(this).attr("isOpen","true")})})})}};$.fn.extend({buildMbMenu:function(op,m,type,e){var msie6=$.browser.msie&&$.browser.version=="6.0";var mouseOver=$.browser.msie?"mouseenter":"mouseover";var mouseOut=$.browser.msie?"mouseleave":"mouseout";$(document).bind("click",function(){$(document).removeMbMenu(op)});if(e){this.mouseX=$(this).getMouseX(e);this.mouseY=$(this).getMouseY(e)}if($.mbMenu.options.actualMenuOpener&&$.mbMenu.options.actualMenuOpener!=op){$(op).removeMbMenu($.mbMenu.options.actualMenuOpener)}$.mbMenu.options.actualMenuOpener=op;if(!type||type=="cm"){if(op.rootMenu){$(op.rootMenu).remove();$(op.actualOpenedMenu).removeAttr("isOpen")}op.clicked=true;op.actualOpenedMenu=this;$(op.actualOpenedMenu).attr("isOpen","true");$(op.actualOpenedMenu).addClass("selected")}var opener=this;var where=(!type||type=="cm")?$(document.body):$(this).parent().parent();var menuClass=op.options.menuSelector.replace(".","");where.append("<div class='menuDiv'><div class='"+menuClass+"' style='display:table'></div></div>");this.menu=where.find(".menuDiv");this.menuContainer=$(this.menu).find(op.options.menuSelector);$(this.menuContainer).bind("mouseover",function(){$(opener).addClass("selected")});$(this.menuContainer).css({position:"absolute",opacity:op.options.opacity});if(!$("#"+m).html()){$.ajax({type:"POST",url:op.options.template,cache:false,async:false,data:"menuId="+m+op.options.additionalData!=""?"&"+op.options.additionalData:"",success:function(html){$("body").after(html);$("#"+m).hide()}})}$(this.menuContainer).hide();this.voices=$("#"+m).find("a").clone();if(op.options.shadow){var shadow=$("<div class='menuShadow'></div>").hide();if(msie6){shadow=$("<iframe class='menuShadow'></iframe>").hide()}}$(this.voices).each(function(i){var voice=this;var imgPlace="";var isText=$(voice).attr("rel")=="text";var isTitle=$(voice).attr("rel")=="title";var isSeparator=$(voice).attr("rel")=="separator";if(op.options.hasImages&&!isText){var imgPath=$(voice).attr("img")?$(voice).attr("img"):"blank.gif";imgPath=(imgPath.length>3&&imgPath.indexOf(".")>-1)?"<img src='"+op.options.iconPath+imgPath+"'>":imgPath;imgPlace="<td class='img'>"+imgPath+"</td>"}var line="<table id='"+m+"_"+i+"' class='line"+(isTitle?" title":"")+"' cellspacing='0' cellpadding='0' border='0' style='width:100%; display:table' width='100%'><tr>"+imgPlace+"<td class='voice' nowrap></td></tr></table>";if(isSeparator){line="<div class='separator' style='width:100%; display:inline-block'></div>"}if(isText){line="<div style='width:100%; display:table' class='line' id='"+m+"_"+i+"'><div class='voice'></div></div>"}$(opener.menuContainer).append(line);if(!isSeparator){$(opener.menuContainer).find("#"+m+"_"+i).find(".voice").append(this);if($(this).attr("menu")){$(opener.menuContainer).find("#"+m+"_"+i).find(".voice a").wrap("<div class='menuArrow'></div>");$(opener.menuContainer).find("#"+m+"_"+i).find(".menuArrow").addClass("subMenuOpener");$(opener.menuContainer).find("#"+m+"_"+i).css({cursor:"default"});this.isOpener=true}if(isText){$(opener.menuContainer).find("#"+m+"_"+i).find(".voice").addClass("textBox");this.isOpener=true}$(opener.menuContainer).find("#"+m+"_"+i).css({cursor:"pointer"});if($(this).attr("disabled")=="true"){$(opener.menuContainer).find("#"+m+"_"+i).addClass("disabled");$(opener.menuContainer).find("#"+m+"_"+i).css({cursor:"default"})}if($(this).attr("disabled")!="true"&&!isText){$(opener.menuContainer).find("#"+m+"_"+i).bind("mouseover",function(event){$(this).addClass("selected");if(opener.menuContainer.actualSubmenu&&!$(voice).attr("menu")){$(opener.menu).find(".menuDiv").remove();$(opener.menuContainer.actualSubmenu).removeClass("selected");opener.menuContainer.actualSubmenu=false;return false}if($(voice).attr("menu")){if(opener.menuContainer.actualSubmenu&&opener.menuContainer.actualSubmenu!=this){$(opener.menu).find(".menuDiv").remove();$(opener.menuContainer.actualSubmenu).removeClass("selected");opener.menuContainer.actualSubmenu=false}if(!$(voice).attr("action")){$(opener.menuContainer).find("#"+m+"_"+i).css("cursor","default")}if(!opener.menuContainer.actualSubmenu||opener.menuContainer.actualSubmenu!=this){$(opener.menu).find(".menuDiv").remove();opener.menuContainer.actualSubmenu=false;$(this).buildMbMenu(op,$(voice).attr("menu"),"sm",event);opener.menuContainer.actualSubmenu=this}$(this).attr("isOpen","true");return false}});$(opener.menuContainer).find("#"+m+"_"+i).bind(mouseOut,function(){$(this).removeClass("selected")})}if($(this).attr("disabled")=="true"){$(opener.menuContainer).find("#"+m+"_"+i).bind(mouseOver,function(event){$(document).unbind("click");if(opener.menuContainer.actualSubmenu){$(opener.menu).find(".menuDiv").remove();opener.menuContainer.actualSubmenu=false}})}$(opener.menuContainer).find("#"+m+"_"+i).bind("click",function(){if(($(voice).attr("action")||$(voice).attr("href"))&&!$(voice).attr("disabled")){eval($(voice).attr("action"));$(this).removeMbMenu(op)}else{if($(voice).attr("menu")){return false}}})}});var t=0,l=0;$(this.menuContainer).css({width:op.options.menuWidth});if($.browser.msie){$(this.menuContainer).css("width",$(this.menuContainer).width()+2)}switch(type){case"sm":t=$(this).position().top+op.options.submenuTop;l=$(this).position().left+$(this).width()-op.options.submenuLeft;break;case"cm":t=this.mouseY-5;l=this.mouseX-5;break;default:if(op.options.openOnRight){t=$(this).offset().top-($.browser.msie?2:0)+op.options.menuTop;l=$(this).offset().left+$(this).outerWidth()-op.options.menuLeft-($.browser.msie?2:0)}else{t=$(this).offset().top+$(this).outerHeight()-(!$.browser.mozilla?2:0)+op.options.menuTop;l=$(this).offset().left+op.options.menuLeft}break}$(this.menu).css({position:"absolute",top:t,left:l});$(this.menuContainer).css(op.options.containerStyle);if(!type||type=="cm"){op.rootMenu=this.menu}$(this.menuContainer).bind(mouseOut,function(){$(document).bind("click",function(){$(document).removeMbMenu(op)})});if(op.options.fadeTime>0){$(this.menuContainer).fadeIn(op.options.fadeTime)}else{$(this.menuContainer).show()}if(op.options.shadow){$(this.menu).prepend(shadow);shadow.css({width:$(this.menuContainer).outerWidth(),height:$(this.menuContainer).outerHeight()-1,position:"absolute",backgroundColor:op.options.shadowColor,border:0,opacity:op.options.shadowOpacity}).show()}var wh=$(window).height();var ww=$(window).width();var mh=$(this.menuContainer).outerHeight();var mw=shadow?shadow.outerWidth():$(this.menuContainer).outerWidth();var actualX=$(where.find(".menuDiv:first")).offset().left;var actualY=$(where.find(".menuDiv:first")).offset().top;switch(type){case"sm":if((actualX+mw)>=ww){l-=((op.options.menuWidth*2)-(op.options.adjustLeft))}break;case"cm":if((actualX+(op.options.menuWidth*1.5))>=ww){l-=((op.options.menuWidth*2)-(op.options.adjustLeft))}break;default:if((actualX+mw)>=ww){l-=($(this.menuContainer).offset().left+mw)-ww}break}if((actualY+mh)>=wh-10){t-=((actualY+mh)-wh)+30}$(this.menu).css({top:t,left:l})},removeMbMenu:function(A){if(!A){A=$.mbMenu.options.actualMenuOpener}if(A.rootMenu){$(A.actualOpenedMenu).removeAttr("isOpen");$(A.actualOpenedMenu).removeClass("selected");$(A.rootMenu).remove();A.rootMenu=false;A.clicked=false;$(document).unbind("click")}},getMouseX:function(B){var A;if($.browser.msie){A=event.clientX+document.body.scrollLeft}else{A=B.pageX}if(A<0){A=0}return A},getMouseY:function(B){var A;if($.browser.msie){A=event.clientY+document.body.scrollTop}else{A=B.pageY}if(A<0){A=0}return A}});$.fn.buildMenu=$.mbMenu.buildMenu;$.fn.buildContextualMenu=$.mbMenu.buildContextualMenu;